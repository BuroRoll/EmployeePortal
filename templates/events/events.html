<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Мероприятия</title>
    <link rel="stylesheet" href={% static "style/style.css" %}>
    <link rel="stylesheet" href={% static "style/events.css" %}>
    <link rel="stylesheet" href={% static "style/adaptive-style.css" %}>
    <link rel="stylesheet" href={% static "style/events.css" %}>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital@0;1&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body class="grey" onload="set_events()">
<header>
    <div class="header-container">
        <a href="/">
            <img class="logo" src={% static  "img/logo.png" %} alt="Логотип">
        </a>
        <div class="right-header">
            <h1>Личный кабинет</h1>
            <div class="delta-header">
                <img class="profile-header" src=/media/{{ request.user.photo }} alt="Аватарка">
                <h2 class="nickname-header">{{ request.user.login }}</h2>
                <a href="/logout" style="height: 28px"><img src={% static "img/out.png" %} alt="Выход" width="28px"
                                                            height="28px"></a>
            </div>
        </div>
    </div>
</header>
<div class="content-container">
    <div class="left-menu">
        <ul>
            <a href="/">
                <li class="left-menu-element"><img class="left-menu-img" src={% static 'img/profile.png' %} alt=""><span
                        class="left-menu-text">Профиль</span></li>
            </a>
            <a href="/vacations/">
                <li class="left-menu-element"><img class="left-menu-img" src={% static 'img/calen.png' %} alt=""><span
                        class="left-menu-text">График отпусков</span></li>
            </a>
            <a href="/get_access/">
                <li class="left-menu-element"><img class="left-menu-img" src={% static 'img/set.png' %} alt=""><span
                        class="left-menu-text">Доступы к системам</span></li>
            </a>
            <a href="/get_all_employees">
                <li class="left-menu-element"><img class="left-menu-img" src={% static 'img/sotrud.png' %} alt=""><span
                        class="left-menu-text">Список сотрудников</span></li>
            </a>
            <a href="/devices">
                <li class="left-menu-element"><img class="left-menu-img" src={% static 'img/sotrud.png' %} alt=""><span
                        class="left-menu-text">Тестовые девайсы</span></li>
            </a>
            {% if request.user.position.access_to_candidates %}
                <a href="/get_all_candidates">
                    <li class="left-menu-element"><img class="left-menu-img"
                                                       src={% static "img/sotrud.png" %} alt=""><span
                            class="left-menu-text">Список кандидатов</span></li>
                </a>
            {% endif %}
            {% if request.user.position.access_to_vacation_list %}
                <a href="/download_vacations">
                    <li class="left-menu-element"><img class="left-menu-img"
                                                       src={% static "img/calen_list.png" %} alt=""><span
                            class="left-menu-text">Список отпусков</span></li>
                </a>
            {% endif %}
        </ul>
    </div>

    <div class="events-container" id="events_container">
    </div>

</div>
<script src={% static "js/events-animation.js" %}></script>
<script>
    async function set_events() {
        fetch('/events_list/', {
            method: 'GET'
        }).then(response => response.json())
            .then(response => {
                set_data(response)
            }).then(() => {
            f()
        });
    }

    async function set_data(data) {
        let container = document.getElementById('events_container')
        for (const event of data) {
            let event_html = create_event(event)
            if (event_html == null)
                continue
            container.appendChild(event_html)
        }
    }

    function create_event(event_data) {
        let free_places = event_data.members_count - event_data.members.length
        let event_date_data = event_data.event_date.split(/[.,/]+/)
        let event_date = new Date(event_date_data[2], event_date_data[1] - 1, event_date_data[0])
        let diffDays = Math.ceil(Math.abs(event_date.getTime() - new Date().getTime()) / (1000 * 3600 * 24));
        if (new Date().getTime() - event_date.getTime() > 86400000)
            return null
        const div = document.createElement('div')
        div.setAttribute('class', 'event-block  no-show')
        div.innerHTML = `

                    <img class="event-img" src=${event_data.picture} alt="">
                    <div class="event-content">
                        <div class="event-panel"><h1>${event_data.title}</h1> <img class="pointer" src={% static "img/strelka.png"%} alt=""></div>
                        <div class="event-count">
                            <div class="free-place">Свободных мест: <span class="free-places">${free_places}</span></div>
                            <div class="day-event">Дней до начала: <span class="days-before-start">${diffDays}</span></div>
                        </div>
                        <div class="info-block">
                            <div class="event-info-block">
                                <div class="event-info-block-left">
                                    <h4 class="title-event">Время выставки</h4>
                                    <p class="date-info">${event_data.event_date}<br>${event_data.event_time}</p>
                                </div>
                                <div class="event-info-block-right">
                                    <h4 class="title-event">Место проведения</h4>
                                    <p class="event-place">${event_data.event_place}</p>
                                </div>
                            </div>

                            <div class="event-anons">
                                <h4 class="title-event">Описание</h4>
                                <p class="event-opisanie">${event_data.description}</p>
                            </div>

                            <div class="party">
                                <div>Всего мест: <span class="max-count">${event_data.members_count}</span></div>
                                <a href="" style="color: grey; text-decoration: underline">Список участников</a>
                            </div>

                            <div class="event-sub green-btn" id='${event_data.id}'>
                                Подать заявку
                            </div>
                        </div>
                    </div>
                </div>
        `
        let subBtn = div.querySelector('.event-sub')
        if (event_data.members.includes({{ user.id }})) {
            subBtn.textContent = 'Отменить заявку'
            subBtn.classList.remove('green-btn')
            subBtn.classList.add('red-btn')
        } else {
            subBtn.textContent = 'Подать заявку'
            subBtn.classList.remove('red-btn')
            subBtn.classList.add('green-btn')
        }
        if (free_places <= 0) {
            subBtn.disabled = true
            console.log(subBtn.disabled)
        }
        return div;
    }

    function f() {
        let event_blocks = document.querySelectorAll('.event-block')

        for (let block of event_blocks) {
            let pointer = block.querySelector('.pointer')


            //Укорачивание названия
            let title = block.querySelector('h1')
            title.data = title.textContent
            title.textContent = title.textContent.length > 20 ? title.textContent.substring(0, 20) + '...' : title.data

            //Настройка цветов
            let freePlace = block.querySelector('.free-places')
            let daysBefore = block.querySelector('.days-before-start')
            let maxPlace = block.querySelector('.max-count')

            if (daysBefore.textContent <= 3) {
                daysBefore.classList.add('red-text')
            } else {
                daysBefore.classList.add('green-text')
            }

            if (freePlace.textContent / maxPlace.textContent < 0.2) {
                freePlace.classList.add('red-text')
            } else {
                freePlace.classList.add('green-text')
            }

            //Раскрытие блока
            pointer.onclick = function () {
                if (block.classList.contains('no-show')) {
                    block.classList.add('show')
                    block.classList.remove('no-show')
                    pointer.style.transform = 'rotate(270deg)'
                    title.textContent = title.data
                } else {
                    block.classList.add('no-show')
                    block.classList.remove('show')
                    pointer.style.transform = 'rotate(90deg)'
                    title.textContent = title.textContent.length > 20 ? title.textContent.substring(0, 20) + '...' : title.data
                }
            }

            let subBtn = block.querySelector('.event-sub')

            //Обработка кнопки мероприятия
            subBtn.onclick = function () {
                if (subBtn.classList.contains('green-btn') && parseInt(freePlace.textContent) > 0) {
                    //Добавление в мероприятие
                    $.ajax({
                        url: '/join_event/?event_id=' + subBtn.id,
                        type: "GET",
                        success: function (data) {
                            console.log(data)
                            subBtn.textContent = 'Отменить заявку'
                            subBtn.classList.remove('green-btn')
                            subBtn.classList.add('red-btn')
                            freePlace.textContent--
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                } else {
                    $.ajax({
                        url: '/unjoin_event/?event_id=' + subBtn.id,
                        type: "GET",
                        success: function (data) {
                            console.log(data)
                            subBtn.textContent = 'Подать заявку'
                            subBtn.classList.remove('red-btn')
                            subBtn.classList.add('green-btn')
                            freePlace.textContent++
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });

                }
            }


        }

    }

</script>
<script>
    const csrftoken = getCookie('csrftoken')
    let event_id = 5
    let title = 'Название221 231'
    let event_date = '21.07.2021'
    let event_time = '11:30'
    let event_place = 'Москва'
    let description = 'Тут новое описание'
    let show_members = true
    let show_members_count = true
    let members_count = 12
    //Редактирование события
    $.ajax({
        url: '/update_event/',
        type: "POST",
        headers: {
            //ВАЖНО!!!
            "X-CSRFToken": csrftoken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            event_id: event_id,
            title: title,
            event_date: event_date,
            event_time: event_time,
            event_place: event_place,
            description: description,
            show_members: show_members,
            show_members_count: show_members_count,
            members_count: members_count,
        }),
        success: function (data) {
            console.log(data)
        },
        error: function (error) {
            console.log(error);
        },
        datatype: 'json'
    });


    //Создание события
    $.ajax({
        url: '/create_event/',
        type: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            title: title,
            event_date: event_date,
            event_time: event_time,
            event_place: event_place,
            description: description,
            show_members: show_members,
            show_members_count: show_members_count,
            members_count: members_count,
        }),
        success: function (data) {
            console.log(data)
        },
        error: function (error) {
            console.log(error);
        },
        datatype: 'json'
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
</body>
</html>